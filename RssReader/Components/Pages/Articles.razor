@page "/"
@page "/articles"
@rendermode InteractiveServer
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.QuickGrid
@using RssReader.Models
@using RssReader.ViewModels
@using RssReader.Data
@using RssReader.Services
@using RssReader.Components.Shared
@using RssReader.Components.Articles
@implements IDisposable
@inject IDbContextFactory<RssReader.Data.RssReaderContext> DbFactory
@inject DataUpdateNotificationService NotificationService
@inject ILogger<Articles> Logger
@inject FeedService FeedService

<PageTitle>Articles</PageTitle>

<h1>Articles</h1>

<AlertDisplay @bind-Alert="_alert" />

<div class="mb-3 row">
    <div class="col-md-3 col-lg-2">
        <input type="search" 
               class="form-control" 
               @bind="_titleFilter" 
               @bind:event="oninput" 
               placeholder="Search by article title or feed name" 
               aria-label="Search articles by title or feed name" />
    </div>
    
    <div class="col-md-9 col-lg-10 d-flex align-items-center gap-2 flex-wrap">
        <div class="btn-group" role="group" aria-label="Filter articles">
            <button type="button" 
                    class="btn btn-sm @(_readFilter == ReadFilter.Unread ? "btn-primary" : "btn-outline-secondary")"
                    @onclick="() => SetReadFilter(ReadFilter.Unread)"
                    title="Show unread articles">
                <i class="bi bi-envelope"></i> Unread
            </button>
            <button type="button" 
                    class="btn btn-sm @(_readFilter == ReadFilter.Read ? "btn-primary" : "btn-outline-secondary")"
                    @onclick="() => SetReadFilter(ReadFilter.Read)"
                    title="Show read articles">
                <i class="bi bi-envelope-open"></i> Read
            </button>
            <button type="button" 
                    class="btn btn-sm @(_favoriteFilter == FavoriteFilter.Favorite ? "btn-primary" : "btn-outline-secondary")"
                    @onclick="() => SetFavoriteFilter(FavoriteFilter.Favorite)"
                    title="Show favorite articles">
                <i class="bi bi-star-fill"></i> Favorite
            </button>
            <button type="button" 
                    class="btn btn-sm @(_favoriteFilter == FavoriteFilter.NonFavorite ? "btn-primary" : "btn-outline-secondary")"
                    @onclick="() => SetFavoriteFilter(FavoriteFilter.NonFavorite)"
                    title="Show non-favorite articles">
                <i class="bi bi-star"></i> Non-Favorite
            </button>
        </div>
        
        @if (_readFilter != ReadFilter.All || _favoriteFilter != FavoriteFilter.All)
        {
            <button type="button" 
                    class="btn btn-sm btn-outline-secondary"
                    @onclick="ClearFilters"
                    title="Clear all filters">
                <i class="bi bi-x-circle"></i> Clear Filters
            </button>
        }
        
        <div class="btn-group" role="group" aria-label="Article actions">
            <button type="button" 
                    class="btn btn-sm btn-outline-primary"
                    @onclick="MarkAllAsRead"
                    disabled="@_isProcessing"
                    title="Mark all visible articles as read">
                <i class="bi bi-check-all"></i> Mark All Read
            </button>
            <button type="button" 
                    class="btn btn-sm btn-outline-success"
                    @onclick="UpdateAllFeeds"
                    disabled="@_isProcessing"
                    title="Update all feeds">
                @if (_isProcessing)
                {
                    <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                }
                else
                {
                    <i class="bi bi-arrow-clockwise"></i>
                }
                Update Feeds
            </button>
        </div>
    </div>
    
    @if (!string.IsNullOrEmpty(_filterInfo))
    {
        <div class="col-12 mt-2">
            <span class="text-muted me-2">
                <i class="bi bi-funnel me-1"></i>@_filterInfo
            </span>
            <a href="/articles" class="btn btn-sm btn-outline-secondary">Clear</a>
        </div>
    }
</div>

@if (_isLoadingArticles)
{
    <div class="text-center my-4">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading articles...</span>
        </div>
    </div>
}
else if (!_articles.Any())
{
    <div class="alert alert-info" role="alert">
        <i class="bi bi-info-circle me-2"></i>No articles yet. Add some feeds to see articles here.
    </div>
}
else
{
    <div class="table-responsive">
        <QuickGrid Class="table" Items="FilteredArticles" Pagination="_pagination">
            <TemplateColumn Title="Feed" SortBy="@(GridSort<ArticleListItem>.ByAscending(a => a.FeedTitle ?? string.Empty))">
                @if (!string.IsNullOrEmpty(context.FeedTitle))
                {
                    <FeedIcon ImageUrl="@context.FeedImageUrl" Title="@context.FeedTitle" />
                    <a href="@context.FeedLink" target="_blank" rel="noopener noreferrer">@context.FeedTitle</a>
                }
                else
                {
                    <span class="text-muted">Unknown Feed</span>
                }
            </TemplateColumn>
            <TemplateColumn Title="Title" SortBy="@(GridSort<ArticleListItem>.ByAscending(a => a.Title))">
                <button class="btn btn-link text-start p-0 text-decoration-none" 
                        @onclick="() => ShowArticleContent(context)"
                        style="color: inherit;"
                        aria-label="@($"Read article: {context.Title}")">
                    @context.Title
                </button>
            </TemplateColumn>
            <TemplateColumn Title="">
                <button class="btn btn-sm btn-link p-0 border-0" 
                        @onclick="() => ToggleReadStatus(context)"
                        title="@(context.IsRead ? "Mark as unread" : "Mark as read")"
                        aria-label="@(context.IsRead ? "Mark as unread" : "Mark as read")">
                    <i class="bi @(context.IsRead ? "bi-envelope-open icon-read" : "bi-envelope icon-unread")"></i>
                </button>
            </TemplateColumn>
            <TemplateColumn Title="">
                <button class="btn btn-sm btn-link p-0 border-0" 
                        @onclick="() => ToggleFavoriteStatus(context)"
                        title="@(context.IsFavorite ? "Remove from favorites" : "Add to favorites")"
                        aria-label="@(context.IsFavorite ? "Remove from favorites" : "Add to favorites")">
                    <i class="bi @(context.IsFavorite ? "bi-star-fill icon-favorite-filled" : "bi-star icon-favorite")"></i>
                </button>
            </TemplateColumn>
            <TemplateColumn Title="">
                <a href="@context.Link" 
                   target="_blank" 
                   rel="noopener noreferrer" 
                   class="btn btn-sm btn-link" 
                   title="Read on source website"
                   aria-label="@($"Read {context.Title} on source website")">
                    <i class="bi bi-box-arrow-up-right icon-external-link"></i>
                </a>
            </TemplateColumn>
            <PropertyColumn Property="@(a => a.PublishDate)" Format="yyyy-MM-dd HH:mm" Title="PublishDate" Sortable="true"/>
        </QuickGrid>
    </div>
    <Paginator State="_pagination" />
}

<ArticleViewer Article="_selectedArticle"
               IsVisible="@(_selectedArticle != null)"
               OnClose="CloseArticleContent"
               OnToggleRead="HandleToggleReadFromViewer"
               OnToggleFavorite="HandleToggleFavoriteFromViewer" />

@code {
    private const int DefaultItemsPerPage = 30;
    private const int MaxArticlesToLoad = 1000;
    
    private enum ReadFilter { All, Read, Unread }
    private enum FavoriteFilter { All, Favorite, NonFavorite }
    
    private PaginationState _pagination = new PaginationState { ItemsPerPage = DefaultItemsPerPage };
    private List<ArticleListItem> _articles = new();
    private string _titleFilter = string.Empty;
    private string _filterInfo = string.Empty;
    private int _currentCategoryId = -1;
    private int _currentFeedId = -1;
    private Article? _selectedArticle = null;
    private Alert? _alert;
    private bool _isLoadingArticles = true;
    private bool _disposed = false;
    private bool _isProcessing = false;
    private ReadFilter _readFilter = ReadFilter.All;
    private FavoriteFilter _favoriteFilter = FavoriteFilter.All;

    [SupplyParameterFromQuery(Name = "categoryId")]
    public int? CategoryId { get; set; }

    [SupplyParameterFromQuery(Name = "feedId")]
    public int? FeedId { get; set; }

    private IQueryable<ArticleListItem> FilteredArticles
    {
        get
        {
            IEnumerable<ArticleListItem> query = _articles;
            
            if (!string.IsNullOrWhiteSpace(_titleFilter))
            {
                var filterLower = _titleFilter.ToLowerInvariant();
                query = query.Where(a => 
                    (a.Title != null && a.Title.Contains(_titleFilter, StringComparison.OrdinalIgnoreCase)) ||
                    (a.FeedTitle != null && a.FeedTitle.Contains(_titleFilter, StringComparison.OrdinalIgnoreCase)));
            }
            
            if (_readFilter == ReadFilter.Read)
            {
                query = query.Where(a => a.IsRead);
            }
            else if (_readFilter == ReadFilter.Unread)
            {
                query = query.Where(a => !a.IsRead);
            }
            
            if (_favoriteFilter == FavoriteFilter.Favorite)
            {
                query = query.Where(a => a.IsFavorite);
            }
            else if (_favoriteFilter == FavoriteFilter.NonFavorite)
            {
                query = query.Where(a => !a.IsFavorite);
            }
            
            return query.AsQueryable();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        NotificationService.OnFeedsUpdated += HandleFeedsUpdated;
        NotificationService.OnCategoriesUpdated += HandleCategoriesUpdated;
        
        await LoadArticlesAsync();
    }

    protected override async Task OnParametersSetAsync()
    {
        var newCategoryId = CategoryId ?? 0;
        var newFeedId = FeedId ?? 0;
        
        if (_currentCategoryId != newCategoryId || _currentFeedId != newFeedId)
        {
            _currentCategoryId = newCategoryId;
            _currentFeedId = newFeedId;
            _titleFilter = string.Empty;
            _pagination = new PaginationState { ItemsPerPage = DefaultItemsPerPage };
            _alert = null;
            await LoadArticlesAsync();
        }
    }

    private async Task LoadArticlesAsync()
    {
        try
        {
            _isLoadingArticles = true;
            await using var context = await DbFactory.CreateDbContextAsync();
            
            IQueryable<Article> query;

            if (FeedId.HasValue && FeedId.Value > 0)
            {
                query = context.Set<Article>()
                    .Where(a => a.FeedId == FeedId.Value);
                
                var feed = await context.Feed
                    .Where(f => f.Id == FeedId.Value)
                    .Select(f => new { f.Title, CategoryName = f.Category != null ? f.Category.Name : null })
                    .FirstOrDefaultAsync();
                
                if (feed != null)
                {
                    _filterInfo = $"Feed: {feed.Title}";
                    if (feed.CategoryName != null)
                    {
                        _filterInfo += $" (Category: {feed.CategoryName})";
                    }
                }
                else
                {
                    _filterInfo = "Feed not found";
                    Logger.LogWarning("Feed with ID {FeedId} not found", FeedId.Value);
                }
            }
            else if (CategoryId.HasValue && CategoryId.Value > 0)
            {
                query = context.Set<Article>()
                    .Where(a => a.Feed!.CategoryId == CategoryId.Value);
                
                var category = await context.Category
                    .Where(c => c.Id == CategoryId.Value)
                    .Select(c => c.Name)
                    .FirstOrDefaultAsync();
                    
                if (category != null)
                {
                    _filterInfo = $"Category: {category}";
                }
                else
                {
                    _filterInfo = "Category not found";
                    Logger.LogWarning("Category with ID {CategoryId} not found", CategoryId.Value);
                }
            }
            else
            {
                query = context.Set<Article>();
                _filterInfo = string.Empty;
            }

            query = ApplyReadAndFavoriteFilters(query);

            _articles = await query
                .OrderByDescending(a => a.PublishDate)
                .Take(MaxArticlesToLoad)
                .Select(a => new ArticleListItem
                {
                    Id = a.Id,
                    Title = a.Title,
                    Link = a.Link,
                    PublishDate = a.PublishDate,
                    IsRead = a.IsRead,
                    IsFavorite = a.IsFavorite,
                    FeedId = a.FeedId,
                    FeedTitle = a.Feed != null ? a.Feed.Title : null,
                    FeedLink = a.Feed != null ? a.Feed.Link : null,
                    FeedImageUrl = a.Feed != null ? a.Feed.ImageUrl : null,
                    CategoryName = a.Feed != null && a.Feed.Category != null ? a.Feed.Category.Name : null
                })
                .ToListAsync();
                
            Logger.LogInformation("Loaded {ArticleCount} articles", _articles.Count);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading articles. CategoryId: {CategoryId}, FeedId: {FeedId}", CategoryId, FeedId);
            _alert = Alert.Error($"Failed to load articles: {ex.Message}");
            _articles = new List<ArticleListItem>();
        }
        finally
        {
            _isLoadingArticles = false;
        }
    }

    private IQueryable<Article> ApplyReadAndFavoriteFilters(IQueryable<Article> query)
    {
        if (_readFilter == ReadFilter.Unread)
        {
            query = query.Where(a => !a.IsRead);
        }
        else if (_readFilter == ReadFilter.Read)
        {
            query = query.Where(a => a.IsRead);
        }

        if (_favoriteFilter == FavoriteFilter.Favorite)
        {
            query = query.Where(a => a.IsFavorite);
        }
        else if (_favoriteFilter == FavoriteFilter.NonFavorite)
        {
            query = query.Where(a => !a.IsFavorite);
        }

        return query;
    }

    private async Task ShowArticleContent(ArticleListItem articleItem)
    {
        await using var context = await DbFactory.CreateDbContextAsync();
        
        _selectedArticle = await context.Set<Article>()
            .Include(a => a.Feed)
            .ThenInclude(f => f!.Category)
            .FirstOrDefaultAsync(a => a.Id == articleItem.Id);
        
        if (_selectedArticle != null && !_selectedArticle.IsRead)
        {
            await MarkArticleAsRead(articleItem);
        }
    }

    private void CloseArticleContent()
    {
        _selectedArticle = null;
    }

    private async Task MarkArticleAsRead(ArticleListItem articleItem)
    {
        try
        {
            await using var context = await DbFactory.CreateDbContextAsync();
            
            await context.Set<Article>()
                .Where(a => a.Id == articleItem.Id)
                .ExecuteUpdateAsync(setters => setters.SetProperty(a => a.IsRead, true));
            
            articleItem.IsRead = true;
            
            if (_selectedArticle != null)
            {
                _selectedArticle.IsRead = true;
            }
            
            Logger.LogInformation("Marked article as read: {ArticleId}", articleItem.Id);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to mark article as read: {ArticleId}", articleItem.Id);
            _alert = Alert.Error($"Failed to mark article as read: {ex.Message}");
        }
    }

    private async Task ToggleReadStatus(ArticleListItem articleItem)
    {
        try
        {
            var newStatus = !articleItem.IsRead;
            
            await using var context = await DbFactory.CreateDbContextAsync();
            
            await context.Set<Article>()
                .Where(a => a.Id == articleItem.Id)
                .ExecuteUpdateAsync(setters => setters.SetProperty(a => a.IsRead, newStatus));
            
            articleItem.IsRead = newStatus;
            
            if (_selectedArticle != null && _selectedArticle.Id == articleItem.Id)
            {
                _selectedArticle.IsRead = newStatus;
            }
            
            Logger.LogInformation("Toggled read status for article {ArticleId} to {IsRead}", articleItem.Id, newStatus);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to update read status for article: {ArticleId}", articleItem.Id);
            _alert = Alert.Error($"Failed to update read status: {ex.Message}");
        }
    }

    private async Task ToggleFavoriteStatus(ArticleListItem articleItem)
    {
        try
        {
            var newStatus = !articleItem.IsFavorite;
            
            await using var context = await DbFactory.CreateDbContextAsync();
            
            await context.Set<Article>()
                .Where(a => a.Id == articleItem.Id)
                .ExecuteUpdateAsync(setters => setters.SetProperty(a => a.IsFavorite, newStatus));
            
            articleItem.IsFavorite = newStatus;
            
            if (_selectedArticle != null && _selectedArticle.Id == articleItem.Id)
            {
                _selectedArticle.IsFavorite = newStatus;
            }
            
            Logger.LogInformation("Toggled favorite status for article {ArticleId} to {IsFavorite}", articleItem.Id, newStatus);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to update favorite status for article: {ArticleId}", articleItem.Id);
            _alert = Alert.Error($"Failed to update favorite status: {ex.Message}");
        }
    }

    private async Task HandleToggleReadFromViewer(Article article)
    {
        var articleItem = _articles.FirstOrDefault(a => a.Id == article.Id);
        if (articleItem != null)
        {
            await ToggleReadStatus(articleItem);
        }
    }

    private async Task HandleToggleFavoriteFromViewer(Article article)
    {
        var articleItem = _articles.FirstOrDefault(a => a.Id == article.Id);
        if (articleItem != null)
        {
            await ToggleFavoriteStatus(articleItem);
        }
    }

    private async void HandleFeedsUpdated()
    {
        if (_disposed) return;

        try
        {
            await InvokeAsync(async () =>
            {
                await LoadArticlesAsync();
                StateHasChanged();
            });
        }
        catch (ObjectDisposedException)
        {
            // Component disposed
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error handling feeds updated event");
        }
    }

    private async void HandleCategoriesUpdated()
    {
        if (_disposed) return;

        try
        {
            await InvokeAsync(async () =>
            {
                await LoadArticlesAsync();
                StateHasChanged();
            });
        }
        catch (ObjectDisposedException)
        {
            // Component disposed
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error handling categories updated event");
        }
    }

    private void SetReadFilter(ReadFilter filter)
    {
        if (_readFilter == filter)
        {
            _readFilter = ReadFilter.All;
        }
        else
        {
            _readFilter = filter;
        }
        _pagination = new PaginationState { ItemsPerPage = DefaultItemsPerPage };
    }
    
    private void SetFavoriteFilter(FavoriteFilter filter)
    {
        if (_favoriteFilter == filter)
        {
            _favoriteFilter = FavoriteFilter.All;
        }
        else
        {
            _favoriteFilter = filter;
        }
        _pagination = new PaginationState { ItemsPerPage = DefaultItemsPerPage };
    }
    
    private async Task ClearFilters()
    {
        _titleFilter = string.Empty;
        _readFilter = ReadFilter.All;
        _favoriteFilter = FavoriteFilter.All;
        _pagination = new PaginationState { ItemsPerPage = DefaultItemsPerPage };
        _alert = null;
        await LoadArticlesAsync();
    }
    
    private async Task MarkAllAsRead()
    {
        if (_isProcessing) return;
        
        try
        {
            _isProcessing = true;
            
            var articlesToMark = FilteredArticles.Where(a => !a.IsRead).Select(a => a.Id).ToList();
            
            if (!articlesToMark.Any())
            {
                _alert = Alert.Info("All visible articles are already marked as read.");
                return;
            }
            
            await using var context = await DbFactory.CreateDbContextAsync();
            
            await context.Set<Article>()
                .Where(a => articlesToMark.Contains(a.Id))
                .ExecuteUpdateAsync(setters => setters.SetProperty(a => a.IsRead, true));
            
            foreach (var article in _articles.Where(a => articlesToMark.Contains(a.Id)))
            {
                article.IsRead = true;
            }
            
            _alert = Alert.Success($"Marked {articlesToMark.Count} article(s) as read.");
            Logger.LogInformation("Marked {Count} articles as read", articlesToMark.Count);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to mark all articles as read");
            _alert = Alert.Error($"Failed to mark articles as read: {ex.Message}");
        }
        finally
        {
            _isProcessing = false;
        }
    }
    
    private async Task UpdateAllFeeds()
    {
        if (_isProcessing) return;
        
        try
        {
            _isProcessing = true;
            _alert = Alert.Info("Updating all feeds...");
            
            await FeedService.UpdateAllFeedsAsync();
            
            await LoadArticlesAsync();
            
            _alert = Alert.Success("All feeds updated successfully.");
            Logger.LogInformation("All feeds updated successfully");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to update all feeds");
            _alert = Alert.Error($"Failed to update feeds: {ex.Message}");
        }
        finally
        {
            _isProcessing = false;
        }
    }

    public void Dispose()
    {
        _disposed = true;
        NotificationService.OnFeedsUpdated -= HandleFeedsUpdated;
        NotificationService.OnCategoriesUpdated -= HandleCategoriesUpdated;
    }
}

@page "/"
@page "/articles"
@rendermode InteractiveServer
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.QuickGrid
@using RssReader.Models
@using RssReader.ViewModels
@using RssReader.Data
@using RssReader.Services
@using RssReader.Components.Shared
@using RssReader.Components.Articles
@implements IDisposable
@inject IDbContextFactory<RssReader.Data.RssReaderContext> DbFactory
@inject UpdateNotifier NotificationService
@inject ILogger<Articles> Logger
@inject FeedManager FeedService
@inject ArticleQueryService ArticleQuery

<PageTitle>RssReader</PageTitle>

<AlertDisplay @bind-Alert="_alert" />

@if (_updateProgress != null && _isProcessing)
{
    <div class="card mb-3">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">
                    <i class="bi bi-arrow-clockwise"></i> Updating Feeds
                </h6>
                <span class="badge bg-primary">@_updateProgress.Percentage%</span>
            </div>
            <div class="progress mb-2" style="height: 25px;">
                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                     role="progressbar" 
                     style="width: @(_updateProgress.Percentage)%"
                     aria-valuenow="@_updateProgress.Percentage" 
                     aria-valuemin="0" 
                     aria-valuemax="100">
                    @_updateProgress.ProcessedFeeds / @_updateProgress.TotalFeeds
                </div>
            </div>
            <div class="d-flex justify-content-between text-muted small">
                <span>
                    @if (!string.IsNullOrEmpty(_updateProgress.CurrentFeedTitle))
                    {
                        <span>Current: @_updateProgress.CurrentFeedTitle</span>
                    }
                </span>
                <span>
                    <span class="text-success me-2">? @_updateProgress.SuccessfulFeeds</span>
                    @if (_updateProgress.FailedFeeds > 0)
                    {
                        <span class="text-danger">? @_updateProgress.FailedFeeds</span>
                    }
                </span>
            </div>
        </div>
    </div>
}

<div class="mb-4">
    <div class="row g-3">
        <div class="col-12 col-md-4 col-lg-3">
            <div class="input-group">
                <span class="input-group-text bg-light border-end-0">
                    <i class="bi bi-search"></i>
                </span>
                <input type="search" 
                       class="form-control border-start-0 ps-0" 
                       @bind="_titleFilter" 
                       @bind:event="oninput" 
                       placeholder="Search articles..." 
                       aria-label="Search articles by title or feed name" />
            </div>
        </div>
        
        <div class="col-12 col-md-8 col-lg-9">
            <div class="d-flex align-items-center gap-2 flex-wrap">
                <div class="btn-group shadow-sm" role="group" aria-label="Filter articles">
                    <button type="button" 
                            class="btn btn-sm @(_readFilter == ReadFilter.Unread ? "btn-primary" : "btn-outline-secondary")"
                            @onclick="async () => await SetReadFilter(ReadFilter.Unread)"
                            title="Show unread articles">
                        <i class="bi bi-envelope me-1"></i>
                        <span class="d-none d-md-inline">Unread</span>
                    </button>
                    <button type="button" 
                            class="btn btn-sm @(_readFilter == ReadFilter.Read ? "btn-primary" : "btn-outline-secondary")"
                            @onclick="async () => await SetReadFilter(ReadFilter.Read)"
                            title="Show read articles">
                        <i class="bi bi-envelope-open me-1"></i>
                        <span class="d-none d-md-inline">Read</span>
                    </button>
                    <button type="button" 
                            class="btn btn-sm @(_favoriteFilter == FavoriteFilter.Favorite ? "btn-primary" : "btn-outline-secondary")"
                            @onclick="async () => await SetFavoriteFilter(FavoriteFilter.Favorite)"
                            title="Show favorite articles">
                        <i class="bi bi-star-fill me-1"></i>
                        <span class="d-none d-md-inline">Favorites</span>
                    </button>
                    <button type="button" 
                            class="btn btn-sm @(_favoriteFilter == FavoriteFilter.NonFavorite ? "btn-primary" : "btn-outline-secondary")"
                            @onclick="async () => await SetFavoriteFilter(FavoriteFilter.NonFavorite)"
                            title="Show non-favorite articles">
                        <i class="bi bi-star me-1"></i>
                        <span class="d-none d-md-inline">Non-Favorites</span>
                    </button>
                </div>
                
                @if (_readFilter != ReadFilter.All || _favoriteFilter != FavoriteFilter.All)
                {
                    <button type="button" 
                            class="btn btn-sm btn-outline-danger"
                            @onclick="ClearFilters"
                            title="Clear all filters">
                        <i class="bi bi-x-circle me-1"></i>
                        <span class="d-none d-md-inline">Clear</span>
                    </button>
                }
                
                <div class="ms-auto d-flex gap-2">
                    <button type="button" 
                            class="btn btn-sm btn-outline-primary shadow-sm"
                            @onclick="MarkAllAsRead"
                            disabled="@_isProcessing"
                            title="Mark all visible articles as read">
                        <i class="bi bi-check-all me-1"></i>
                        <span class="d-none d-lg-inline">Mark All Read</span>
                    </button>
                    <button type="button" 
                            class="btn btn-sm btn-success shadow-sm"
                            @onclick="UpdateAllFeeds"
                            disabled="@_isProcessing"
                            title="Update all feeds">
                        @if (_isProcessing)
                        {
                            <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                        }
                        else
                        {
                            <i class="bi bi-arrow-clockwise me-1"></i>
                        }
                        <span class="d-none d-lg-inline">Update Feeds</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    @if (!string.IsNullOrEmpty(_filterInfo))
    {
        <div class="row mt-3">
            <div class="col-12">
                <div class="alert alert-info d-flex align-items-center justify-content-between py-2 mb-0" role="alert">
                    <span>
                        <i class="bi bi-funnel-fill me-2"></i>
                        <strong>Active Filter:</strong> @_filterInfo
                    </span>
                    <a href="/articles" class="btn btn-sm btn-outline-info">
                        <i class="bi bi-x-lg me-1"></i>Clear
                    </a>
                </div>
            </div>
        </div>
    }
</div>

@if (_isLoadingArticles)
{
    <div class="text-center my-4">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading articles...</span>
        </div>
    </div>
}
else if (!_articles.Any())
{
    <div class="alert alert-info" role="alert">
        <i class="bi bi-info-circle me-2"></i>No articles yet. Add some feeds to see articles here.
    </div>
}
else
{
    <div class="table-responsive">
        <QuickGrid Class="table article-grid" Items="FilteredArticles">
            <TemplateColumn Title="Feed" SortBy="@(GridSort<ArticleListItem>.ByAscending(a => a.FeedTitle ?? string.Empty))">
                <div class="@(context.IsRead ? "" : "article-row-unread")">
                    @if (!string.IsNullOrEmpty(context.FeedTitle))
                    {
                        <FeedIcon ImageUrl="@context.FeedImageUrl" Title="@context.FeedTitle" />
                        <a href="@GetFeedFilterUrl(context.FeedId)" class="text-decoration-none">@context.FeedTitle</a>
                    }
                    else
                    {
                        <span class="text-muted">Unknown Feed</span>
                    }
                </div>
            </TemplateColumn>
            <TemplateColumn Title="Title" SortBy="@(GridSort<ArticleListItem>.ByAscending(a => a.Title))">
                <div class="@(context.IsRead ? "" : "article-row-unread")">
                    <button class="btn btn-link text-start p-0 text-decoration-none" 
                            @onclick="() => ShowArticleContent(context)"
                            style="color: inherit;"
                            aria-label="@($"Read article: {context.Title}")">
                        @context.Title
                    </button>
                </div>
            </TemplateColumn>
            <TemplateColumn Title="">
                <div class="@(context.IsRead ? "" : "article-row-unread")">
                    <button class="btn btn-sm btn-link p-0 border-0" 
                            @onclick="() => ToggleReadStatus(context)"
                            title="@(context.IsRead ? "Mark as unread" : "Mark as read")"
                            aria-label="@(context.IsRead ? "Mark as unread" : "Mark as read")">
                        <i class="bi @(context.IsRead ? "bi-envelope-open icon-read" : "bi-envelope icon-unread")"></i>
                    </button>
                </div>
            </TemplateColumn>
            <TemplateColumn Title="">
                <div class="@(context.IsRead ? "" : "article-row-unread")">
                    <button class="btn btn-sm btn-link p-0 border-0" 
                            @onclick="() => ToggleFavoriteStatus(context)"
                            title="@(context.IsFavorite ? "Remove from favorites" : "Add to favorites")"
                            aria-label="@(context.IsFavorite ? "Remove from favorites" : "Add to favorites")">
                        <i class="bi @(context.IsFavorite ? "bi-star-fill icon-favorite-filled" : "bi-star icon-favorite")"></i>
                    </button>
                </div>
            </TemplateColumn>
            <TemplateColumn Title="">
                <div class="@(context.IsRead ? "" : "article-row-unread")">
                    <a href="@context.Link" 
                       target="_blank" 
                       rel="noopener noreferrer" 
                       class="btn btn-sm btn-link" 
                       title="Read on source website"
                       aria-label="@($"Read {context.Title} on source website")">
                        <i class="bi bi-box-arrow-up-right icon-external-link"></i>
                    </a>
                </div>
            </TemplateColumn>
            <TemplateColumn Title="PublishDate" SortBy="@(GridSort<ArticleListItem>.ByAscending(a => a.PublishDate))" Class="d-none d-md-table-cell">
                <div class="@(context.IsRead ? "" : "article-row-unread")">
                    @context.PublishDate.ToString("yyyy-MM-dd HH:mm")
                </div>
            </TemplateColumn>
        </QuickGrid>
    </div>
    
    @if (_hasMoreArticles && !_isLoadingMore)
    {
        <div class="text-center my-4">
            <button type="button" 
                    class="btn btn-outline-primary"
                    @onclick="async () => await LoadMoreArticlesAsync()"
                    disabled="@_isProcessing">
                <i class="bi bi-arrow-down-circle me-2"></i>Load More Articles
            </button>
            <div class="text-muted small mt-2">
                Currently showing @_articles.Count articles
            </div>
        </div>
    }
    else if (_isLoadingMore)
    {
        <div class="text-center my-4">
            <div class="spinner-border spinner-border-sm" role="status">
                <span class="visually-hidden">Loading more articles...</span>
            </div>
            <div class="text-muted small mt-2">Loading more articles...</div>
        </div>
    }
    else if (!_hasMoreArticles && _articles.Count >= InitialLoadSize)
    {
        <div class="text-center my-4">
            <div class="text-muted small">
                <i class="bi bi-check-circle me-1"></i>All articles loaded (@_articles.Count total)
            </div>
        </div>
    }
}

<ArticleViewer Article="_selectedArticle"
               IsVisible="@(_selectedArticle != null)"
               OnClose="CloseArticleContent"
               OnToggleRead="HandleToggleReadFromViewer"
               OnToggleFavorite="HandleToggleFavoriteFromViewer" />

@code {
    private const int InitialLoadSize = 100;
    private const int LoadMoreSize = 50;
    
    private enum ReadFilter { All, Read, Unread }
    private enum FavoriteFilter { All, Favorite, NonFavorite }
    
    private List<ArticleListItem> _articles = new();
    private string _titleFilter = string.Empty;
    private string _filterInfo = string.Empty;
    private int _currentCategoryId = -1;
    private int _currentFeedId = -1;
    private Article? _selectedArticle = null;
    private Alert? _alert;
    private bool _isLoadingArticles = true;
    private bool _isLoadingMore = false;
    private bool _hasMoreArticles = true;
    private bool _disposed = false;
    private bool _isProcessing = false;
    private ReadFilter _readFilter = ReadFilter.All;
    private FavoriteFilter _favoriteFilter = FavoriteFilter.All;
    private FeedUpdateProgress? _updateProgress = null;

    [SupplyParameterFromQuery(Name = "categoryId")]
    public int? CategoryId { get; set; }

    [SupplyParameterFromQuery(Name = "feedId")]
    public int? FeedId { get; set; }

    private IQueryable<ArticleListItem> FilteredArticles
    {
        get
        {
            IEnumerable<ArticleListItem> query = _articles;
            
            if (!string.IsNullOrWhiteSpace(_titleFilter))
            {
                query = query.Where(a => 
                    (a.Title != null && a.Title.Contains(_titleFilter, StringComparison.OrdinalIgnoreCase)) ||
                    (a.FeedTitle != null && a.FeedTitle.Contains(_titleFilter, StringComparison.OrdinalIgnoreCase)));
            }
            
            return query.AsQueryable();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        NotificationService.OnFeedsUpdated += HandleFeedsUpdated;
        NotificationService.OnCategoriesUpdated += HandleCategoriesUpdated;
        NotificationService.OnFeedUpdateProgress += HandleFeedUpdateProgress;
        
        await LoadArticlesAsync();
    }

    protected override async Task OnParametersSetAsync()
    {
        var newCategoryId = CategoryId ?? 0;
        var newFeedId = FeedId ?? 0;
        
        if (_currentCategoryId != newCategoryId || _currentFeedId != newFeedId)
        {
            _currentCategoryId = newCategoryId;
            _currentFeedId = newFeedId;
            _titleFilter = string.Empty;
            _alert = null;
            await LoadArticlesAsync();
        }
    }

    private async Task LoadArticlesAsync()
    {
        try
        {
            _isLoadingArticles = true;
            _hasMoreArticles = true;
            
            if (FeedId.HasValue && FeedId.Value > 0)
            {
                var feedInfo = await ArticleQuery.GetFeedFilterInfoAsync(FeedId.Value);
                
                if (feedInfo != null)
                {
                    _filterInfo = $"Feed: {feedInfo.FeedTitle}";
                    if (feedInfo.CategoryName != null)
                    {
                        _filterInfo += $" (Category: {feedInfo.CategoryName})";
                    }
                }
                else
                {
                    _filterInfo = "Feed not found";
                    Logger.LogWarning("Feed with ID {FeedId} not found", FeedId.Value);
                    _articles = new List<ArticleListItem>();
                    _hasMoreArticles = false;
                    return;
                }
            }
            else if (CategoryId.HasValue && CategoryId.Value > 0)
            {
                var categoryName = await ArticleQuery.GetCategoryNameAsync(CategoryId.Value);
                    
                if (categoryName != null)
                {
                    _filterInfo = $"Category: {categoryName}";
                }
                else
                {
                    _filterInfo = "Category not found";
                    Logger.LogWarning("Category with ID {CategoryId} not found", CategoryId.Value);
                    _articles = new List<ArticleListItem>();
                    _hasMoreArticles = false;
                    return;
                }
            }
            else
            {
                _filterInfo = string.Empty;
            }

            bool? isReadFilter = _readFilter switch
            {
                ReadFilter.Read => true,
                ReadFilter.Unread => false,
                _ => null
            };

            bool? isFavoriteFilter = _favoriteFilter switch
            {
                FavoriteFilter.Favorite => true,
                FavoriteFilter.NonFavorite => false,
                _ => null
            };

            var result = await ArticleQuery.GetArticlesAsync(
                feedId: FeedId,
                categoryId: CategoryId,
                isRead: isReadFilter,
                isFavorite: isFavoriteFilter,
                take: InitialLoadSize);

            if (result.Success)
            {
                _articles = result.Articles;
                _hasMoreArticles = result.Articles.Count >= InitialLoadSize;
                Logger.LogInformation("Loaded {ArticleCount} articles", _articles.Count);
            }
            else
            {
                Logger.LogError("Failed to load articles: {Error}", result.ErrorMessage);
                _alert = Alert.Error($"Failed to load articles: {result.ErrorMessage}");
                _articles = new List<ArticleListItem>();
                _hasMoreArticles = false;
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading articles. CategoryId: {CategoryId}, FeedId: {FeedId}", CategoryId, FeedId);
            _alert = Alert.Error($"Failed to load articles: {ex.Message}");
            _articles = new List<ArticleListItem>();
            _hasMoreArticles = false;
        }
        finally
        {
            _isLoadingArticles = false;
        }
    }

    private async Task LoadMoreArticlesAsync()
    {
        if (_isLoadingMore || _isProcessing || !_hasMoreArticles) return;
        
        try
        {
            _isLoadingMore = true;
            
            bool? isReadFilter = _readFilter switch
            {
                ReadFilter.Read => true,
                ReadFilter.Unread => false,
                _ => null
            };

            bool? isFavoriteFilter = _favoriteFilter switch
            {
                FavoriteFilter.Favorite => true,
                FavoriteFilter.NonFavorite => false,
                _ => null
            };

            var result = await ArticleQuery.GetArticlesAsync(
                feedId: FeedId,
                categoryId: CategoryId,
                isRead: isReadFilter,
                isFavorite: isFavoriteFilter,
                skip: _articles.Count,
                take: LoadMoreSize);

            if (result.Success)
            {
                if (result.Articles.Any())
                {
                    _articles.AddRange(result.Articles);
                    _hasMoreArticles = result.Articles.Count >= LoadMoreSize;
                    Logger.LogInformation("Loaded {Count} more articles, total now {Total}", 
                        result.Articles.Count, _articles.Count);
                }
                else
                {
                    _hasMoreArticles = false;
                    Logger.LogInformation("No more articles to load");
                }
            }
            else
            {
                Logger.LogError("Failed to load more articles: {Error}", result.ErrorMessage);
                _alert = Alert.Error($"Failed to load more articles: {result.ErrorMessage}");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading more articles");
            _alert = Alert.Error($"Failed to load more articles: {ex.Message}");
        }
        finally
        {
            _isLoadingMore = false;
        }
    }

    private async Task ShowArticleContent(ArticleListItem articleItem)
    {
        await using var context = await DbFactory.CreateDbContextAsync();
        
        _selectedArticle = await context.Set<Article>()
            .Include(a => a.Feed)
            .ThenInclude(f => f!.Category)
            .FirstOrDefaultAsync(a => a.Id == articleItem.Id);
        
        if (_selectedArticle != null && !_selectedArticle.IsRead)
        {
            await MarkArticleAsRead(articleItem);
        }
    }

    private void CloseArticleContent()
    {
        _selectedArticle = null;
    }

    private async Task MarkArticleAsRead(ArticleListItem articleItem)
    {
        try
        {
            await using var context = await DbFactory.CreateDbContextAsync();
            
            await context.Set<Article>()
                .Where(a => a.Id == articleItem.Id)
                .ExecuteUpdateAsync(setters => setters.SetProperty(a => a.IsRead, true));
            
            articleItem.IsRead = true;
            
            if (_selectedArticle != null)
            {
                _selectedArticle.IsRead = true;
            }
            
            Logger.LogInformation("Marked article as read: {ArticleId}", articleItem.Id);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to mark article as read: {ArticleId}", articleItem.Id);
            _alert = Alert.Error($"Failed to mark article as read: {ex.Message}");
        }
    }

    private async Task ToggleReadStatus(ArticleListItem articleItem)
    {
        try
        {
            var newStatus = !articleItem.IsRead;
            
            await using var context = await DbFactory.CreateDbContextAsync();
            
            await context.Set<Article>()
                .Where(a => a.Id == articleItem.Id)
                .ExecuteUpdateAsync(setters => setters.SetProperty(a => a.IsRead, newStatus));
            
            articleItem.IsRead = newStatus;
            
            if (_selectedArticle != null && _selectedArticle.Id == articleItem.Id)
            {
                _selectedArticle.IsRead = newStatus;
            }
            
            // Re-sort articles: unread first, then by publish date
            _articles = _articles
                .OrderBy(a => a.IsRead)
                .ThenByDescending(a => a.PublishDate)
                .ToList();
            
            Logger.LogInformation("Toggled read status for article {ArticleId} to {IsRead}", articleItem.Id, newStatus);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to update read status for article: {ArticleId}", articleItem.Id);
            _alert = Alert.Error($"Failed to update read status: {ex.Message}");
        }
    }

    private async Task ToggleFavoriteStatus(ArticleListItem articleItem)
    {
        try
        {
            var newStatus = !articleItem.IsFavorite;
            
            await using var context = await DbFactory.CreateDbContextAsync();
            
            await context.Set<Article>()
                .Where(a => a.Id == articleItem.Id)
                .ExecuteUpdateAsync(setters => setters.SetProperty(a => a.IsFavorite, newStatus));
            
            articleItem.IsFavorite = newStatus;
            
            if (_selectedArticle != null && _selectedArticle.Id == articleItem.Id)
            {
                _selectedArticle.IsFavorite = newStatus;
            }
            
            Logger.LogInformation("Toggled favorite status for article {ArticleId} to {IsFavorite}", articleItem.Id, newStatus);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to update favorite status for article: {ArticleId}", articleItem.Id);
            _alert = Alert.Error($"Failed to update favorite status: {ex.Message}");
        }
    }

    private async Task HandleToggleReadFromViewer(Article article)
    {
        var articleItem = _articles.FirstOrDefault(a => a.Id == article.Id);
        if (articleItem != null)
        {
            await ToggleReadStatus(articleItem);
        }
    }

    private async Task HandleToggleFavoriteFromViewer(Article article)
    {
        var articleItem = _articles.FirstOrDefault(a => a.Id == article.Id);
        if (articleItem != null)
        {
            await ToggleFavoriteStatus(articleItem);
        }
    }

    private async void HandleFeedsUpdated()
    {
        if (_disposed) return;

        try
        {
            await InvokeAsync(async () =>
            {
                await LoadArticlesAsync();
                StateHasChanged();
            });
        }
        catch (ObjectDisposedException)
        {
            // Component disposed
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error handling feeds updated event");
        }
    }

    private async void HandleCategoriesUpdated()
    {
        if (_disposed) return;

        try
        {
            await InvokeAsync(async () =>
            {
                await LoadArticlesAsync();
                StateHasChanged();
            });
        }
        catch (ObjectDisposedException)
        {
            // Component disposed
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error handling categories updated event");
        }
    }

    private async void HandleFeedUpdateProgress(FeedUpdateProgress progress)
    {
        if (_disposed) return;

        try
        {
            await InvokeAsync(() =>
            {
                _updateProgress = progress;
                StateHasChanged();
            });
        }
        catch (ObjectDisposedException)
        {
            // Component disposed
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error handling feed update progress event");
        }
    }

    private async Task SetReadFilter(ReadFilter filter)
    {
        if (_readFilter == filter)
        {
            _readFilter = ReadFilter.All;
        }
        else
        {
            _readFilter = filter;
        }
        await LoadArticlesAsync();
    }
    
    private async Task SetFavoriteFilter(FavoriteFilter filter)
    {
        if (_favoriteFilter == filter)
        {
            _favoriteFilter = FavoriteFilter.All;
        }
        else
        {
            _favoriteFilter = filter;
        }
        await LoadArticlesAsync();
    }
    
    private async Task ClearFilters()
    {
        _titleFilter = string.Empty;
        _readFilter = ReadFilter.All;
        _favoriteFilter = FavoriteFilter.All;
        _alert = null;
        await LoadArticlesAsync();
    }
    
    private async Task MarkAllAsRead()
    {
        if (_isProcessing) return;
        
        try
        {
            _isProcessing = true;
            
            var articlesToMark = FilteredArticles.Where(a => !a.IsRead).Select(a => a.Id).ToList();
            
            if (!articlesToMark.Any())
            {
                _alert = Alert.Info("All visible articles are already marked as read.");
                return;
            }
            
            await using var context = await DbFactory.CreateDbContextAsync();
            
            await context.Set<Article>()
                .Where(a => articlesToMark.Contains(a.Id))
                .ExecuteUpdateAsync(setters => setters.SetProperty(a => a.IsRead, true));
            
            foreach (var article in _articles.Where(a => articlesToMark.Contains(a.Id)))
            {
                article.IsRead = true;
            }
            
            // Re-sort articles: unread first, then by publish date
            _articles = _articles
                .OrderBy(a => a.IsRead)
                .ThenByDescending(a => a.PublishDate)
                .ToList();
            
            _alert = Alert.Success($"Marked {articlesToMark.Count} article(s) as read.");
            Logger.LogInformation("Marked {Count} articles as read", articlesToMark.Count);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to mark all articles as read");
            _alert = Alert.Error($"Failed to mark articles as read: {ex.Message}");
        }
        finally
        {
            _isProcessing = false;
        }
    }
    
    private async Task UpdateAllFeeds()
    {
        if (_isProcessing) return;
        
        try
        {
            _isProcessing = true;
            _updateProgress = null;
            _alert = Alert.Info("Updating all feeds...");
            
            var result = await FeedService.UpdateAllFeedsAsync();
            
            _updateProgress = null;
            
            await LoadArticlesAsync();
            
            if (result.FailedUpdates == 0)
            {
                _alert = Alert.Success($"All {result.SuccessfulUpdates} feed(s) updated successfully.");
            }
            else if (result.SuccessfulUpdates == 0)
            {
                _alert = Alert.Error($"Failed to update all {result.FailedUpdates} feed(s). Check logs for details.");
            }
            else
            {
                _alert = Alert.Warning($"Updated {result.SuccessfulUpdates} feed(s) successfully, but {result.FailedUpdates} feed(s) failed. Check logs for details.");
            }
            
            Logger.LogInformation("Feed update completed: {Success} successful, {Failed} failed", 
                result.SuccessfulUpdates, result.FailedUpdates);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to update all feeds");
            _alert = Alert.Error($"Failed to update feeds: {ex.Message}");
            _updateProgress = null;
        }
        finally
        {
            _isProcessing = false;
        }
    }

    public void Dispose()
    {
        _disposed = true;
        NotificationService.OnFeedsUpdated -= HandleFeedsUpdated;
        NotificationService.OnCategoriesUpdated -= HandleCategoriesUpdated;
        NotificationService.OnFeedUpdateProgress -= HandleFeedUpdateProgress;
    }

    private string GetFeedFilterUrl(int feedId)
    {
        return $"/articles?feedId={feedId}";
    }
}

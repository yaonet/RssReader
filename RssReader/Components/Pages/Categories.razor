@page "/categories"
@rendermode InteractiveServer
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.QuickGrid
@using RssReader.Models
@using RssReader.Data
@using RssReader.Services
@using RssReader.ViewModels
@using RssReader.Components.Shared
@using System.ComponentModel.DataAnnotations;
@inject IDbContextFactory<RssReader.Data.RssReaderContext> DbFactory
@inject UpdateNotifier NotificationService

<PageTitle>Categories</PageTitle>

<AlertDisplay @bind-Alert="alert" />

<div class="row">
    <div class="col-md-4">
        <EditForm method="post" Model="categoryInput" OnValidSubmit="AddCategory" FormName="create" Enhance>
            <DataAnnotationsValidator />
            <ValidationSummary class="text-danger" role="alert" />
            <div class="mb-3">
                <div class="input-group">
                    <InputText id="categoryName" @bind-Value="categoryInput.CategoryName" class="form-control" aria-required="true" placeholder="Enter category name" />
                    <button type="submit" class="btn btn-primary" disabled="@isLoading">
                        @if (isLoading)
                        {
                            <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                        }
                        Create
                    </button>
                </div>
                <ValidationMessage For="() => categoryInput.CategoryName" class="text-danger" />
            </div>
        </EditForm>
    </div>
</div>

@if (isLoadingCategories)
{
    <div class="text-center my-4">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading categories...</span>
        </div>
    </div>
}
else if (!allCategories.Any())
{
    <div class="alert alert-info" role="alert">
        <i class="bi bi-info-circle me-2"></i>No categories yet. Create your first category above.
    </div>
}
else
{
    <QuickGrid Class="table" Items="allCategories.AsQueryable()">
        <PropertyColumn Property="category => category.Name" Title="Category" />
        <TemplateColumn Title="" Context="category">
            <button class="btn btn-sm btn-link p-0 border-0 text-primary" 
                    @onclick="() => OpenCategoryManagement(category)"
                    aria-label="@($"Manage category {category.Name}")">
                <i class="bi bi-gear-fill"></i>
            </button>
        </TemplateColumn>
    </QuickGrid>
}

<RssReader.Components.Categories.CategoryEditor @bind-IsVisible="isSidebarVisible"
                                                  CurrentCategory="selectedCategoryForManagement"
                                                  OnCategoryUpdated="HandleCategoryUpdated"
                                                  OnCategoryDeleted="HandleCategoryDeleted" />

@code {
    [SupplyParameterFromForm]
    private InputModel categoryInput { get; set; } = default!;

    private Alert? alert;
    private List<Category> allCategories = new();
    private bool isLoading = false;
    private bool isLoadingCategories = true;
    private bool isSidebarVisible = false;
    private Category? selectedCategoryForManagement = null;

    private sealed class InputModel
    {
        [Required(ErrorMessage = "Category name is required.")]
        [StringLength(30, MinimumLength = 2, ErrorMessage = "Category name must be between 2 and 30 characters.")]
        public string? CategoryName { get; set; }
    }

    protected override void OnInitialized()
    {
        categoryInput ??= new InputModel();
    }

    protected override async Task OnInitializedAsync()
    {  
        await LoadCategoriesAsync();
    }

    private async Task LoadCategoriesAsync()
    {
        try
        {
            isLoadingCategories = true;
            await using var context = await DbFactory.CreateDbContextAsync();
            allCategories = await context.Category.OrderBy(c => c.Name).ToListAsync();
        }
        catch (Exception ex)
        {
            alert = Alert.Error($"Failed to load categories: {ex.Message}");
        }
        finally
        {
            isLoadingCategories = false;
        }
    }

    private async Task AddCategory()
    {
        try
        {
            isLoading = true;
            await using var context = await DbFactory.CreateDbContextAsync();
            var name = categoryInput.CategoryName!.Trim();

            var exists = await context.Category.AnyAsync(c => c.Name!.ToLower() == name.ToLower());
            if (exists)
            {
                alert = Alert.Error($"Category '{name}' already exists.");
                return;
            }

            context.Category.Add(new Category
            {
                Name = name
            });

            await context.SaveChangesAsync();
            
            alert = Alert.Success($"Category '{name}' created successfully.");
            categoryInput.CategoryName = string.Empty;
            
            await LoadCategoriesAsync();
            
            NotificationService.NotifyCategoriesUpdated();
        }
        catch (DbUpdateException)
        {
            alert = Alert.Error($"A category with this name already exists or a database constraint was violated.");
        }
        catch (Exception ex)
        {
            alert = Alert.Error($"Failed to create category: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void OpenCategoryManagement(Category category)
    {
        selectedCategoryForManagement = category;
        isSidebarVisible = true;
        alert = null;
    }

    private async Task HandleCategoryUpdated()
    {
        await LoadCategoriesAsync();
        NotificationService.NotifyCategoriesUpdated();
    }

    private async Task HandleCategoryDeleted()
    {
        alert = Alert.Success($"Category deleted successfully!");
        await LoadCategoriesAsync();
        NotificationService.NotifyCategoriesUpdated();
        selectedCategoryForManagement = null;
    }
}
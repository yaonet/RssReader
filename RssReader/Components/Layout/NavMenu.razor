@rendermode InteractiveServer
@using Microsoft.EntityFrameworkCore
@using RssReader.Models
@using RssReader.Data
@using RssReader.Services
@using RssReader.Components.Shared
@implements IDisposable
@inject IDbContextFactory<RssReaderContext> DbFactory
@inject DataUpdateNotificationService NotificationService
@inject ILogger<NavMenu> Logger

<div class="top-row ps-3 navbar navbar-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="">RssReader</a>
    </div>
</div>

<input type="checkbox" 
       id="navbar-toggler"
       title="Navigation menu" 
       class="navbar-toggler"
       aria-label="Toggle navigation menu" />

<div class="nav-scrollable" onclick="document.querySelector('.navbar-toggler').click()">
    <nav class="nav flex-column">
        <div class="nav-item px-3">
            <NavLink class="nav-link d-flex align-items-center" href="@Constants.Routes.Home" Match="NavLinkMatch.All">
                <i class="bi bi-house-door-fill me-2"></i> Articles
            </NavLink>
        </div>

        <div class="nav-item px-3">
            <NavLink class="nav-link d-flex align-items-center" href="@Constants.Routes.Feeds">
                <i class="bi bi-plus-square-fill me-2"></i> Feed
            </NavLink>
        </div>

        <div class="nav-item px-3">
            <NavLink class="nav-link d-flex align-items-center" href="@Constants.Routes.Categories">
                <i class="bi bi-list-nested me-2"></i> Category
            </NavLink>
        </div>

        @if (isLoading)
        {
            <div class="nav-item px-3 py-3">
                <div class="d-flex align-items-center text-muted">
                    <div class="spinner-border spinner-border-sm me-2" role="status">
                        <span class="visually-hidden">Loading categories...</span>
                    </div>
                    <small>Loading categories...</small>
                </div>
            </div>
        }
        else if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="nav-item px-3">
                <div class="alert alert-danger alert-sm mb-2" role="alert">
                    <small>@errorMessage</small>
                    <button class="btn btn-link btn-sm p-0 ms-2 text-white" 
                            @onclick="RetryLoadCategories"
                            @onclick:stopPropagation="true"
                            aria-label="Retry loading categories">
                        <small>Retry</small>
                    </button>
                </div>
            </div>
        }
        else if (allCategories.Any())
        {
            <hr class="border-secondary opacity-25 mx-3 my-2" />
            
            @foreach (var category in allCategories)
            {
                <div class="nav-item px-3">
                    <div class="nav-category-header d-flex align-items-center">
                        <button class="btn btn-link p-0 border-0 me-2 flex-shrink-0" 
                                style="font-size: 0.875rem; color: inherit;"
                                @onclick="() => ToggleCategory(category.Id)"
                                @onclick:stopPropagation="true"
                                title="@(expandedCategories.Contains(category.Id) ? "Collapse" : "Expand")"
                                aria-label="@(expandedCategories.Contains(category.Id) ? $"Collapse category {category.Name}" : $"Expand category {category.Name}")"
                                aria-expanded="@expandedCategories.Contains(category.Id)">
                            @if (loadingCategoryFeeds.Contains(category.Id))
                            {
                                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="width: 0.875rem; height: 0.875rem;"></span>
                            }
                            else
                            {
                                <i class="bi bi-chevron-@(expandedCategories.Contains(category.Id) ? "down" : "right") cursor-pointer"></i>
                            }
                        </button>
                        <NavLink class="category-link flex-grow-1 text-decoration-none" 
                                 href="@GetCategoryUrl(category.Id)">
                            <span class="category-name">@category.Name</span>
                        </NavLink>
                    </div>

                    @if (expandedCategories.Contains(category.Id))
                    {
                        @if (categoryFeeds.TryGetValue(category.Id, out var feeds) && feeds.Any())
                        {
                            @foreach (var feed in feeds)
                            {
                                <div class="nav-feed-item ps-4">
                                    <NavLink class="nav-link d-flex align-items-center text-truncate" 
                                             href="@GetFeedUrl(feed.Id)">
                                        <FeedIcon ImageUrl="@feed.ImageUrl" 
                                                  Title="@feed.Title" />
                                        <span class="feed-title text-truncate flex-grow-1" title="@feed.Title">@feed.Title</span>
                                    </NavLink>
                                </div>
                            }
                        }
                        else if (!loadingCategoryFeeds.Contains(category.Id))
                        {
                            <div class="nav-feed-item ps-4">
                                <small class="text-muted">No feeds in this category.</small>
                            </div>
                        }
                    }
                </div>
            }
        }
        else
        {
            <div class="nav-item px-3">
                <div class="empty-state text-center py-3">
                    <i class="bi bi-inbox d-block mb-2" style="font-size: 2rem; opacity: 0.3;"></i>
                    <small class="text-muted d-block mb-2">No categories yet.</small>
                    <NavLink href="@Constants.Routes.Categories" class="btn btn-sm btn-link">Add Category</NavLink>
                </div>
            </div>
        }
    </nav>
</div>

@code {
    private List<Category> allCategories = new();
    private Dictionary<int, List<Feed>> categoryFeeds = new();
    private HashSet<int> expandedCategories = new();
    private HashSet<int> loadingCategoryFeeds = new();
    private bool isLoading = true;
    private string? errorMessage;
    private CancellationTokenSource? _loadCts;
    private bool _disposed = false;

    protected override async Task OnInitializedAsync()
    {
        NotificationService.OnCategoriesUpdated += HandleDataUpdated;
        NotificationService.OnFeedsUpdated += HandleFeedsUpdated;

        await LoadCategoriesAsync();
    }

    private async Task LoadCategoriesAsync()
    {
        _loadCts?.Cancel();
        _loadCts?.Dispose();
        _loadCts = new CancellationTokenSource();
        var token = _loadCts.Token;

        isLoading = true;
        errorMessage = null;
        
        try
        {
            await using var context = await DbFactory.CreateDbContextAsync(token);
            
            var categories = await context.Category
                .OrderBy(c => c.Name)
                .AsNoTracking()
                .ToListAsync(token);

            if (token.IsCancellationRequested)
            {
                return;
            }

            CleanupExpandedCategories(categories);
            allCategories = categories;
        }
        catch (OperationCanceledException)
        {
            // Operation was cancelled, this is expected
        }
        catch (Exception ex)
        {
            errorMessage = "Failed to load categories";
            Logger.LogError(ex, "Error loading categories");
            allCategories = new List<Category>();
        }
        finally
        {
            if (!token.IsCancellationRequested)
            {
                isLoading = false;
            }
        }
    }

    private async Task LoadCategoryFeedsAsync(int categoryId)
    {
        if (categoryFeeds.ContainsKey(categoryId))
        {
            return;
        }

        loadingCategoryFeeds.Add(categoryId);
        
        try
        {
            await using var context = await DbFactory.CreateDbContextAsync();
            
            var feeds = await context.Feed
                .Where(f => f.CategoryId == categoryId)
                .OrderBy(f => f.Title)
                .AsNoTracking()
                .ToListAsync();

            categoryFeeds[categoryId] = feeds;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading feeds for category {CategoryId}", categoryId);
            categoryFeeds[categoryId] = new List<Feed>();
        }
        finally
        {
            loadingCategoryFeeds.Remove(categoryId);
        }
    }

    private void CleanupExpandedCategories(List<Category> categories)
    {
        var validCategoryIds = new HashSet<int>(categories.Select(c => c.Id));
        expandedCategories.RemoveWhere(id => !validCategoryIds.Contains(id));
        
        var invalidFeedKeys = categoryFeeds.Keys.Where(k => !validCategoryIds.Contains(k)).ToList();
        foreach (var key in invalidFeedKeys)
        {
            categoryFeeds.Remove(key);
        }
    }

    private async void HandleDataUpdated()
    {
        if (_disposed)
        {
            return;
        }

        try
        {
            await InvokeAsync(async () =>
            {
                categoryFeeds.Clear();
                await LoadCategoriesAsync();
                
                foreach (var categoryId in expandedCategories.ToList())
                {
                    await LoadCategoryFeedsAsync(categoryId);
                }
                
                StateHasChanged();
            });
        }
        catch (ObjectDisposedException)
        {
            // Component has been disposed, ignore
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error handling data update in NavMenu");
            
            try
            {
                await InvokeAsync(() =>
                {
                    errorMessage = "Failed to refresh data";
                    StateHasChanged();
                });
            }
            catch (ObjectDisposedException)
            {
                // Component disposed during error handling
            }
        }
    }

    private async void HandleFeedsUpdated()
    {
        if (_disposed)
        {
            return;
        }

        try
        {
            await InvokeAsync(async () =>
            {
                foreach (var categoryId in expandedCategories.ToList())
                {
                    categoryFeeds.Remove(categoryId);
                    await LoadCategoryFeedsAsync(categoryId);
                }
                
                StateHasChanged();
            });
        }
        catch (ObjectDisposedException)
        {
            // Component has been disposed, ignore
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error handling feeds update in NavMenu");
        }
    }

    private async Task RetryLoadCategories()
    {
        await LoadCategoriesAsync();
    }

    private async Task ToggleCategory(int categoryId)
    {
        if (expandedCategories.Contains(categoryId))
        {
            expandedCategories.Remove(categoryId);
        }
        else
        {
            expandedCategories.Add(categoryId);
            await LoadCategoryFeedsAsync(categoryId);
        }
    }

    private string GetCategoryUrl(int categoryId)
    {
        return $"{Constants.Routes.Articles}?categoryId={categoryId}";
    }

    private string GetFeedUrl(int feedId)
    {
        return $"{Constants.Routes.Articles}?feedId={feedId}";
    }

    public void Dispose()
    {
        _disposed = true;
        
        NotificationService.OnCategoriesUpdated -= HandleDataUpdated;
        NotificationService.OnFeedsUpdated -= HandleFeedsUpdated;
        
        _loadCts?.Cancel();
        _loadCts?.Dispose();
        _loadCts = null;
    }
}

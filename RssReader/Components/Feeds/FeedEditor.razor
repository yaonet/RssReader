@using Microsoft.EntityFrameworkCore
@using RssReader.Models
@using RssReader.Data
@using RssReader.ViewModels
@using RssReader.Components.Shared
@using System.ComponentModel.DataAnnotations
@inject IDbContextFactory<RssReaderContext> DbFactory
@inject ILogger<FeedEditor> Logger

<div class="offcanvas offcanvas-end @(IsVisible ? "show" : "")" 
     tabindex="-1" 
     style="@(IsVisible ? "visibility: visible;" : "")"
     aria-labelledby="feedManagementLabel">
    <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="feedManagementLabel">
            <i class="bi bi-gear me-2"></i>Manage Feed
        </h5>
        <button type="button" class="btn-close" @onclick="Close" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
        @if (CurrentFeed != null && !IsLoading)
        {
            <AlertDisplay @bind-Alert="alert" />

            <EditForm Model="editModel" OnValidSubmit="HandleSave" FormName="editFeed">
                <DataAnnotationsValidator />
                
                <div class="mb-3">
                    <label for="feedTitle" class="form-label">Title</label>
                    <InputText id="feedTitle" @bind-Value="editModel.Title" class="form-control" />
                    <ValidationMessage For="() => editModel.Title" class="text-danger" />
                </div>

                <div class="mb-3">
                    <label for="feedUrl" class="form-label">Feed URL</label>
                    <InputText id="feedUrl" @bind-Value="editModel.Url" class="form-control" />
                    <ValidationMessage For="() => editModel.Url" class="text-danger" />
                </div>

                <div class="mb-3">
                    <label for="feedLink" class="form-label">Website URL</label>
                    <InputText id="feedLink" @bind-Value="editModel.Link" class="form-control" />
                </div>

                <div class="mb-3">
                    <label for="feedDescription" class="form-label">Description</label>
                    <InputTextArea id="feedDescription" @bind-Value="editModel.Description" class="form-control" rows="3" />
                </div>

                <div class="mb-3">
                    <label for="feedImageUrl" class="form-label">Image URL</label>
                    <InputText id="feedImageUrl" @bind-Value="editModel.ImageUrl" class="form-control" />
                </div>

                <div class="mb-3">
                    <label for="feedCategory" class="form-label">Category</label>
                    <InputSelect id="feedCategory" @bind-Value="editModel.CategoryId" class="form-control">
                        @foreach (var category in Categories)
                        {
                            <option value="@category.Id">@category.Name</option>
                        }
                    </InputSelect>
                    <ValidationMessage For="() => editModel.CategoryId" class="text-danger" />
                </div>

                <div class="mb-3">
                    <label class="form-label">Last Updated</label>
                    <input type="text" class="form-control" value="@CurrentFeed.LastUpdated.ToString("yyyy-MM-dd HH:mm:ss")" readonly disabled />
                </div>

                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-primary" disabled="@IsSaving">
                        @if (IsSaving)
                        {
                            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                            <span>Saving...</span>
                        }
                        else
                        {
                            <i class="bi bi-save me-2"></i>
                            <span>Save Changes</span>
                        }
                    </button>
                    <button type="button" class="btn btn-outline-danger" @onclick="ShowDeleteConfirmation" disabled="@IsSaving">
                        <i class="bi bi-trash me-2"></i>Delete Feed
                    </button>
                </div>
            </EditForm>
        }
        else if (IsLoading)
        {
            <div class="text-center my-4">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        }
    </div>
</div>

@if (IsVisible)
{
    <div class="offcanvas-backdrop fade show" @onclick="Close"></div>
}

<DeleteConfirmDialog IsVisible="@showDeleteDialog"
                     Title="Confirm Delete"
                     Message="@GetDeleteMessage()"
                     Warning="@(Alert.Warning("This will also delete all associated articles."))"
                     IsProcessing="@IsDeleting"
                     OnConfirm="ConfirmDelete"
                     OnCancel="CancelDeleteConfirmation" />

@code {
    [Parameter]
    public bool IsVisible { get; set; }

    [Parameter]
    public EventCallback<bool> IsVisibleChanged { get; set; }

    [Parameter]
    public Feed? CurrentFeed { get; set; }

    [Parameter]
    public List<Category> Categories { get; set; } = new();

    [Parameter]
    public EventCallback OnFeedUpdated { get; set; }

    [Parameter]
    public EventCallback OnFeedDeleted { get; set; }

    private FeedEditModel editModel = new();
    private bool IsLoading = false;
    private bool IsSaving = false;
    private bool IsDeleting = false;
    private bool showDeleteDialog = false;
    private Alert? alert;

    protected override void OnParametersSet()
    {
        if (CurrentFeed != null && IsVisible)
        {
            LoadFeedData();
        }
    }

    private void LoadFeedData()
    {
        editModel = new FeedEditModel
        {
            Title = CurrentFeed?.Title ?? string.Empty,
            Url = CurrentFeed?.Url ?? string.Empty,
            Link = CurrentFeed?.Link ?? string.Empty,
            Description = CurrentFeed?.Description ?? string.Empty,
            ImageUrl = CurrentFeed?.ImageUrl ?? string.Empty,
            CategoryId = CurrentFeed?.CategoryId ?? 0
        };
        alert = null;
    }

    private async Task Close()
    {
        IsVisible = false;
        await IsVisibleChanged.InvokeAsync(false);
        alert = null;
        showDeleteDialog = false;
    }

    private async Task HandleSave()
    {
        if (CurrentFeed == null) return;

        IsSaving = true;
        alert = null;

        try
        {
            await using var context = await DbFactory.CreateDbContextAsync();
            var feed = await context.Feed.FindAsync(CurrentFeed.Id);

            if (feed == null)
            {
                alert = Alert.Error("Feed not found.");
                return;
            }

            feed.Title = editModel.Title;
            feed.Url = editModel.Url;
            feed.Link = editModel.Link;
            feed.Description = editModel.Description;
            feed.ImageUrl = editModel.ImageUrl;
            feed.CategoryId = editModel.CategoryId;

            context.Feed.Update(feed);
            await context.SaveChangesAsync();

            alert = Alert.Success("Feed updated successfully!");
            Logger.LogInformation("Successfully updated feed: {FeedId} - {FeedTitle}, CategoryId changed to {CategoryId}", 
                CurrentFeed.Id, feed.Title, feed.CategoryId);

            await OnFeedUpdated.InvokeAsync();
            
            await Task.Delay(1500);
            await Close();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error updating feed: {FeedId}", CurrentFeed.Id);
            alert = Alert.Error($"Failed to update feed: {ex.Message}");
        }
        finally
        {
            IsSaving = false;
        }
    }

    private void ShowDeleteConfirmation()
    {
        showDeleteDialog = true;
        alert = null;
    }

    private void CancelDeleteConfirmation()
    {
        showDeleteDialog = false;
    }

    private async Task ConfirmDelete()
    {
        if (CurrentFeed == null) return;

        IsDeleting = true;

        try
        {
            await using var context = await DbFactory.CreateDbContextAsync();
            var feed = await context.Feed.FindAsync(CurrentFeed.Id);

            if (feed != null)
            {
                context.Feed.Remove(feed);
                await context.SaveChangesAsync();

                Logger.LogInformation("Successfully deleted feed: {FeedId} - {FeedTitle}", CurrentFeed.Id, CurrentFeed.Title);
                
                await OnFeedDeleted.InvokeAsync();
                await Close();
            }
            else
            {
                alert = Alert.Error("Feed not found.");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error deleting feed: {FeedId}", CurrentFeed?.Id);
            alert = Alert.Error($"Failed to delete feed: {ex.Message}");
        }
        finally
        {
            IsDeleting = false;
            showDeleteDialog = false;
        }
    }

    private string GetDeleteMessage()
    {
        return CurrentFeed != null
            ? $"Are you sure you want to delete the feed '{CurrentFeed.Title}'?"
            : string.Empty;
    }

    public class FeedEditModel
    {
        [Required(ErrorMessage = "Title is required")]
        public string Title { get; set; } = string.Empty;

        [Required(ErrorMessage = "URL is required")]
        [Url(ErrorMessage = "Invalid URL format")]
        public string Url { get; set; } = string.Empty;

        public string? Link { get; set; }
        public string? Description { get; set; }
        public string? ImageUrl { get; set; }

        [Range(1, int.MaxValue, ErrorMessage = "Please select a category")]
        public int CategoryId { get; set; }
    }
}

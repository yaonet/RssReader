@namespace RssReader.Components.Shared
@inject NavigationManager Navigation

<div class="feed-icon-wrapper">
    @if (!string.IsNullOrEmpty(ImageUrl) && !_imageLoadFailed)
    {
        <img src="@GetProxiedImageUrl()"
             alt="@(Title ?? "Feed icon")"
             class="feed-icon-img @CssClass"
             style="@Style"
             @onload="HandleImageLoad"
             @onerror="HandleImageError" />
    }
    else
    {
        <i class="bi bi-rss-fill feed-icon-default @CssClass" style="@Style"></i>
    }
</div>

@code {
    [Parameter]
    public string? ImageUrl { get; set; }
    
    [Parameter]
    public string? Title { get; set; }
    
    [Parameter]
    public string CssClass { get; set; } = "me-2 flex-shrink-0";
    
    [Parameter]
    public string Style { get; set; } = "width: 16px; height: 16px; object-fit: contain; vertical-align: text-bottom;";
    
    private bool _imageLoadFailed = false;
    
    private string GetProxiedImageUrl()
    {
        if (string.IsNullOrEmpty(ImageUrl))
        {
            return string.Empty;
        }
        
        // URL encode the image URL
        var encodedUrl = Uri.EscapeDataString(ImageUrl);
        
        // Get base URL from NavigationManager
        var baseUri = Navigation.BaseUri.TrimEnd('/');
        
        return $"{baseUri}/api/image-proxy?url={encodedUrl}";
    }
    
    private void HandleImageLoad()
    {
        _imageLoadFailed = false;
    }
    
    private void HandleImageError()
    {
        _imageLoadFailed = true;
    }
    
    protected override void OnParametersSet()
    {
        _imageLoadFailed = false;
    }
}
